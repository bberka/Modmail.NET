@using FluentValidation
@using Modmail.NET.Common.Exceptions
@using Modmail.NET.Common.Static
@using Modmail.NET.Database.Entities
@using Modmail.NET.Features.Tag.Commands
@using Modmail.NET.Web.Blazor.Extensions
@using Serilog
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ModmailBot Bot
@inject ISender Sender

@code {

  [CascadingParameter]
  public required Task<AuthenticationState> AuthContext { get; set; }

  [Parameter]
  public required Tag? Tag { get; set; }

  public bool IncludeAuthorWhenTicketChannel { get; set; }

  public Embed? Embed { get; set; }


  bool IsUpdate => Tag != null;

  string _name = "";

  private string Name
  {
    get => _name;
    set => _name = Tag.GetTagName(value);
  }


  protected override void OnInitialized()
  {
      if (Tag is not null)
      {
          Name = Tag.Name;
          Embed = Tag.Embed;
      }
  }

  private async Task SubmitAsync()
  {
      //TODO: Validation
      var dialogResult = await Radzen.DialogService.Confirm(IsUpdate ? "Are you sure you want to update this tag ?" : "Are you sure you want to create new tag ?", options: new ConfirmOptions
      {
              OkButtonText = Lang.Yes.Translate(),
              CancelButtonText = Lang.No.Translate(),
              CloseDialogOnOverlayClick = true,
              CloseDialogOnEsc = true
      });
      if (dialogResult == true)
      {
      const string logMessage = $"[{nameof(CreateOrUpdateTagDialogComponent)}]{nameof(SubmitAsync)}({{Name}})";
      try
      {
        var state = await AuthContext;
        var userId = state.User.GetUserId();

        if (IsUpdate && Tag is not null)
        {
            await Sender.Send(new ProcessUpdateTagCommand
            {
                    AuthorizedUserId = userId,
                    TagId = Tag.Id,
                    Name = Name,
                    Embed = Embed ?? throw new ValidationException("Embed cannot be null"),
                    IncludeAuthorWhenTicketChannel = IncludeAuthorWhenTicketChannel
            });
          Log.Information(logMessage, _name);
            Radzen.NotificationService.Notify(NotificationSeverity.Success, "Success", "Tag updated successfully.");
        }
        else
        {
            await Sender.Send(new ProcessCreateTagCommand
            {
                    AuthorizedUserId = userId,
                    Name = Name,
                    Embed = Embed ?? throw new ValidationException("Embed cannot be null"),
                    IncludeAuthorWhenTicketChannel = IncludeAuthorWhenTicketChannel
            });
          Log.Information(logMessage, _name);
            Radzen.NotificationService.Notify(NotificationSeverity.Success, "Success", "Tag created successfully.");
        }

        Radzen.DialogService.Close(true);
      }
      catch (ValidationException ex)
      {
          Log.Warning(ex, logMessage, _name);
          ex.NotifyException(Radzen.NotificationService);
      }
      catch (ModmailBotException ex)
      {
        Log.Warning(ex, logMessage, _name);
        ex.NotifyException(Radzen.NotificationService);
      }
      catch (Exception ex)
      {
        Log.Fatal(ex, logMessage, _name);
        ex.NotifyException(Radzen.NotificationService);
      }
    }
  }


}


<RadzenRow>
  <RadzenColumn>
    <RadzenRow class="rz-my-4">
      <RadzenFormField Text="Name" class="w-100" Variant="Variant.Outlined">
          <RadzenTextBox Name="name" @bind-Value="@Name" Trim="true" MaxLength="DbLength.TagName"/>
      </RadzenFormField>
    </RadzenRow>

    <RadzenRow class="rz-my-4">
        <RadzenFormField Text="Include Author When Used In Ticket Channel" class="w-100" Variant="Variant.Outlined">
            <RadzenCheckBox Name="IncludeAuthorWhenTicketChannel" @bind-Value="@IncludeAuthorWhenTicketChannel"/>
      </RadzenFormField>
    </RadzenRow>

      <hr class="rz-my-7"/>
      <CreateEmbedInputs @bind-Embed="@Database.Entities.Embed"></CreateEmbedInputs>

      <RadzenRow class="rz-my-4">
          <RadzenButton ButtonType="ButtonType.Button" ButtonStyle="ButtonStyle.Primary"
                        Text="@(IsUpdate ? "Update" : "Create")"
                    Click="SubmitAsync"/>
    </RadzenRow>
  </RadzenColumn>
</RadzenRow>