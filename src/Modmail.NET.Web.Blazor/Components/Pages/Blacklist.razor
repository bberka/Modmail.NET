@page "/blacklist"
@using Microsoft.EntityFrameworkCore
@using Modmail.NET.Web.Blazor.Components.Layout.Shared
@using Serilog
@inject ModmailDbContext DbContext
@inject DialogService DialogService
@inject  NotificationService NotificationService

@code {

  private IQueryable<TicketBlacklist>? data;

  bool isLoading = false;

  async Task ShowLoading() {
    isLoading = true;

    await Task.Yield();

    isLoading = false;
  }


  protected override async Task OnInitializedAsync() {
    await base.OnInitializedAsync();

    await ShowLoading();

    var query = DbContext.TicketBlacklists
                         .Include(x => x.DiscordUser)
                         .OrderByDescending(x => x.RegisterDateUtc)
                         .AsQueryable();

    count = query.Count();

    data = query.Skip(0).Take(10).AsQueryable();
  }


  private void LoadDataAsync(LoadDataArgs args) {
    var query = DbContext.TicketBlacklists
                         .Include(x => x.DiscordUser)
                         .OrderByDescending(x => x.RegisterDateUtc)
                         .AsQueryable();
    query = query.ApplyDataGridFilter(args);
    count = query.Count();
    data = query.ApplyPagination(args);
  }

  private int count = 0;

  private async Task RemoveBlockAsync(TicketBlacklist blacklist) {
    var dialogResult = await DialogService.Confirm("Are you sure you want to remove this user from the blacklist?",
                                                   options: new ConfirmOptions() {
                                                     OkButtonText = "Yes",
                                                     CancelButtonText = "No",
                                                     CloseDialogOnOverlayClick = true,
                                                     CloseDialogOnEsc = true,
                                                   });

    if (dialogResult == true) {
      const string logMessage = $"[{nameof(Blacklist)}]{nameof(RemoveBlockAsync)}{{UserId}})";
      try {
        await blacklist.ProcessRemoveUserFromBlacklist(blacklist.DiscordUserId);
        Log.Information(logMessage,
                        blacklist.DiscordUserId);
        NotificationService.Notify(NotificationSeverity.Success,
                                   "User removed from blacklist");
        data = DbContext.TicketBlacklists
                        .Include(x => x.DiscordUser)
                        .OrderByDescending(x => x.RegisterDateUtc)
                        .AsQueryable()
                        .Skip(0)
                        .Take(10)
                        .AsQueryable();
      }
      catch (BotExceptionBase ex) {
        Log.Warning(ex,
                    logMessage,
                    blacklist.DiscordUserId);
        NotificationService.Notify(NotificationSeverity.Error,
                                   ex.Message);
      }
      catch (Exception ex) {
        Log.Fatal(ex,
                  logMessage,
                  blacklist.DiscordUserId);
        NotificationService.Notify(NotificationSeverity.Error,
                                   "Exception occurred, please check logs");
      }
    }
  }

}


<div class="container-xl rz-mx-auto">
  <RadzenRow>
    <RadzenColumn Size="12">
      <RadzenRow>
        <RadzenColumn Size="12">
          <RadzenText TextStyle="TextStyle.H3" class="fw-bold">
            Blacklist
          </RadzenText>
          <p>
            This page shows the list of users that are blacklisted from using the bot.
          </p>
          @* <hr class="my-4"/> *@
        </RadzenColumn>
      </RadzenRow>
      <RadzenRow RowGap="4" class="rz-mt-5">
        @if (data is null) {
          <Loading></Loading>
        }
        else {
          <RadzenCard Style="width: 100% !important;" class="rz-shadow-7">
            <RadzenDataGrid Count="count" LoadData="LoadDataAsync" AllowColumnPicking="true" AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.SimpleWithMenu"
                            AllowGrouping="false" AllowSorting="true" PageSize="10" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" PagerPosition="PagerPosition.TopAndBottom"
                            PagerAlwaysVisible="false" GotoFirstPageOnSort="true"
                            Data="@data" TItem="TicketBlacklist" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or" ShowPagingSummary="true"
                            IsLoading=@isLoading Sort="@ShowLoading" Page="@ShowLoading" Group="@ShowLoading" Filter="@ShowLoading">
              <Columns>
                <RadzenDataGridColumn Visible="false" Property="@nameof(TicketBlacklist.Id)" Filterable="false" Title="ID" Frozen="true" Width="120px" TextAlign="TextAlign.Center"/>
                <RadzenDataGridColumn Title="User Avatar" Frozen="false" Sortable="false" Filterable="false" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenImage class="rz-m-0 rz-p-0" Style="width: 100px; height: 100px" Path="@data.DiscordUser.AvatarUrl" AlternateText=""/>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property="OpenerUser.Username" Title="User" Frozen="false" Sortable="true" Filterable="true" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenText Text="@data.DiscordUser.Username" TextAlign="TextAlign.Center" class="fw-bold"></RadzenText>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Visible="true" Property="@nameof(TicketBlacklist.RegisterDateUtc)" Filterable="true" Title="Register Date UTC" Frozen="true" Width="120px" TextAlign="TextAlign.Center"/>
                <RadzenDataGridColumn Visible="true" Property="@nameof(TicketBlacklist.Reason)" Filterable="true" Title="Reason" Frozen="true" Width="120px" TextAlign="TextAlign.Center"/>

                <RadzenDataGridColumn Context="data" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                  <Template Context="data">
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(async () => await RemoveBlockAsync(data))" @onclick:stopPropagation="true">
                    </RadzenButton>
                  </Template>
                </RadzenDataGridColumn>

              </Columns>
            </RadzenDataGrid>
          </RadzenCard>
        }

      </RadzenRow>
    </RadzenColumn>
  </RadzenRow>
</div>