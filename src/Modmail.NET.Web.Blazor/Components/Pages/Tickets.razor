@page "/tickets"
@using System.Linq.Dynamic.Core
@using Microsoft.EntityFrameworkCore
@using Modmail.NET.Web.Blazor.Components.Layout.Shared
@inject ModmailDbContext DbContext

@code {

  private IQueryable<TicketDto>? data;

  bool isLoading = false;

  async Task ShowLoading() {
    isLoading = true;

    await Task.Yield();

    isLoading = false;
  }


  protected override async Task OnInitializedAsync() {
    await base.OnInitializedAsync();

    await ShowLoading();

    var query = DbContext.Tickets
                         .Include(x => x.OpenerUser)
                         .Include(x => x.CloserUser)
                         .Include(x => x.TicketType)
                         .OrderByDescending(x => x.RegisterDateUtc)
                         .ProjectToDto()
                         .AsQueryable();

    count = query.Count();

    data = query.Skip(0).Take(10).AsQueryable();
  }


  private void LoadDataAsync(LoadDataArgs args) {
    var query = DbContext.Tickets
                         .Include(x => x.OpenerUser)
                         .Include(x => x.CloserUser)
                         .Include(x => x.TicketType)
                         .OrderByDescending(x => x.RegisterDateUtc)
                         .ProjectToDto()
                         .AsQueryable();
    query = query.ApplyDataGridFilter(args);
    count = query.Count();
    data = query.ApplyPagination(args);
  }

  private int count = 0;

}

<div class="container-xl rz-mx-auto">
  <RadzenRow>
    <RadzenColumn Size="12">
      <RadzenRow>
        <RadzenColumn Size="12">
          <RadzenText TextStyle="TextStyle.H3" class="fw-bold">
            Tickets
          </RadzenText>
          <p>
            This page shows the list of tickets that have been opened by users.
          </p>
          @* <hr class="my-4"/> *@
        </RadzenColumn>
      </RadzenRow>
      <RadzenRow RowGap="4" class="rz-mt-5">
        @if (data is null) {
          <Loading></Loading>
        }
        else {
          <RadzenCard Style="width: 100% !important;" class="rz-shadow-7">
            <RadzenDataGrid Count="count" LoadData="LoadDataAsync" AllowColumnPicking="true" AllowFiltering="false" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.SimpleWithMenu"
                            AllowGrouping="false" AllowSorting="true" PageSize="10" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" PagerPosition="PagerPosition.TopAndBottom"
                            PagerAlwaysVisible="false" GotoFirstPageOnSort="true"
                            Data="@data" TItem="TicketDto" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or" ShowPagingSummary="true"
                            IsLoading=@isLoading Sort="@ShowLoading" Page="@ShowLoading" Group="@ShowLoading" Filter="@ShowLoading">
              <Columns>
                <RadzenDataGridColumn Visible="false" Property="@nameof(TicketDto.Id)" Filterable="false" Title="ID" Frozen="true" Width="80px" TextAlign="TextAlign.Center"/>
                <RadzenDataGridColumn Title="Opener User Avatar" Frozen="false" Sortable="false" Filterable="false" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenImage class="rz-m-0 rz-p-0" Style="width: 100px; height: 100px" Path="@data.OpenerUser.AvatarUrl" AlternateText=""/>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property="OpenerUser.Username" Title="Opener User" Frozen="false" Sortable="true" Filterable="true" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenText Text="@data.OpenerUser.Username" TextAlign="TextAlign.Center" class="fw-bold"></RadzenText>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn Title="Closer User Avatar" Frozen="false" Sortable="false" Filterable="false" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenImage Style="width: 100px; height: 100px;" Path="@data.CloserUser?.AvatarUrl" AlternateText=""/>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Title="Closer User" Frozen="true" Sortable="true" Filterable="true" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenText Text="@data.CloserUser?.Username" TextAlign="TextAlign.Center" class="fw-bold"></RadzenText>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn Property="@nameof(TicketDto.RegisterDateUtc)" Title="Register Date Utc" Width="220px"/>
                <RadzenDataGridColumn Visible="false" Property="@nameof(TicketDto.LastMessageDateUtc)" Title="Last Message Date Utc" Width="220px"/>
                <RadzenDataGridColumn Property="@nameof(TicketDto.ClosedDateUtc)" Title="Close Date Utc" Width="220px"/>
                <RadzenDataGridColumn Title="Ticket Type" Frozen="true" Sortable="true" Filterable="true" Width="120px" TextAlign="TextAlign.Center">
                  <Template Context="data">
                    <RadzenStack AlignItems="AlignItems.Center" class="rz-mx-auto rz-my-12">
                      <RadzenText Text="@data.TicketType?.Name" TextAlign="TextAlign.Center" class="fw-bold"></RadzenText>
                    </RadzenStack>
                  </Template>
                </RadzenDataGridColumn>
              </Columns>
            </RadzenDataGrid>
          </RadzenCard>
        }

      </RadzenRow>
    </RadzenColumn>
  </RadzenRow>
</div>